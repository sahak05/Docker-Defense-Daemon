- rule: Write below etc
  desc: An attempt to write to any file below /etc
  condition: container and evt.type = write and fd.name startswith /etc
  output: >
    Write below /etc detected (user=%user.name command=%proc.cmdline file=%fd.name)
  priority: WARNING
  tags: [filesystem, mitre_persistence]

- rule: Read sensitive file
  desc: Detect deliberate reads of sensitive files by user commands
  condition: >
    evt.type in (open, openat) and
    container.id != host and
    proc.name in (cat, less, more, head, tail, grep, awk, sed) and
    proc.tty != 0 and
    (
      fd.name = "/etc/shadow" or
      fd.name = "/etc/passwd" or
      fd.name pmatch ("/root/.ssh/*") or
      fd.name pmatch ("/home/*/.ssh/*")
    )
  output: >
    Sensitive file read (cmd=%proc.cmdline file=%fd.name user=%user.name container=%container.id)
  priority: WARNING
  tags: [filesystem, mitre_discovery]


- rule: Suspicious Download Tool In Container
  desc: Detect execution of common download tools (curl/wget) inside containers fetching remote resources
  condition: container and evt.type = execve and proc.name in (curl, wget) and (proc.cmdline contains "http://" or proc.cmdline contains "https://" or proc.cmdline contains "ftp://")
  output: >
    Suspicious download tool in container (proc=%proc.name user=%user.name container=%container.name image=%container.image cmdline=%proc.cmdline)
  priority: WARNING
  tags: [container, exec, download, mitre_initial_access]

- rule: Outbound connection from container (refined)
  desc: Detect outbound network connections from a container to non-local/non-loopback IPs (parser-friendly)
  condition: >
    container and evt.type = connect and not (fd.sip in (127.0.0.1, 0.0.0.0, ::1)) and fd.sport > 1023
  output: >
    Outbound connection from container (container=%container.id name=%container.name image=%container.image fd.sip=%fd.sip fd.sport=%fd.sport proc=%proc.cmdline)
  priority: NOTICE
  tags: [network, container]

- rule: Package manager activity in container
  desc: Detects use of package managers inside containers
  condition: container and evt.type = execve and proc.name in (apt, apt-get, yum, dnf, apk, zypper, pacman)
  output: >
    Package manager used inside container (container=%container.id user=%user.name command=%proc.cmdline)
  priority: WARNING
  tags: [container, package_mgmt, mitre_persistence]

- rule: Ptrace syscall used
  desc: Detect usage of ptrace which may indicate debugging or process injection
  condition: container and evt.type = ptrace
  output: >
    Ptrace syscall used (user=%user.name command=%proc.cmdline pid=%proc.pid container=%container.name)
  priority: ERROR
  tags: [syscall, mitre_defense_evasion]

# - rule: Read sensitive SSH file in container
#   desc: Detect reads of sensitive SSH-related files in user home directories inside containers
#   condition: >
#     evt.type in (open, openat, read) and
#     fd.name startswith "/root/.ssh/" and
#     container.id != host
#   output: >
#     [ALERT] SSH file read: %fd.name by %proc.name (%proc.cmdline) in container %container.id
#   priority: CRITICAL
#   tags: [ssh, container, falco, sensitive]
